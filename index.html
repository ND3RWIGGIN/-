<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>nd3rwiggin</title>

<style>
/* ---------- BASE ---------- */
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #191f41;
  color: #c8d4e4;
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
}

button {
  font-family: inherit;
}

/* ---------- SCREENS ---------- */
.screen {
  position: fixed;
  inset: 0;
  background: #191f41;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.input-field {
  padding: 10px;
  font-size: 1.1rem;
  margin-top: 10px;
  width: 260px;
  text-align: center;
  border: none;
  border-radius: 6px;
  background: #3b4166;
  color: #c8d4e4;
}

.btn {
  margin-top: 15px;
  padding: 10px 20px;
  background: #48508a;
  border: none;
  color: #c8d4e4;
  border-radius: 6px;
  cursor: pointer;
}

#error-msg, #auth-error {
  color: #ff6b6b;
  margin-top: 10px;
  min-height: 1.2em;
}

/* ---------- MAIN ---------- */
#main-content {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
  display: none;
  flex-direction: column;
}

#nav-tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  border-bottom: 2px solid #48508a;
  padding-bottom: 10px;
}

#nav-tabs button {
  padding: 8px 16px;
  background: transparent;
  border: none;
  color: #c8d4e4;
  cursor: pointer;
  border-radius: 4px;
  font-size: 0.9rem;
}

#nav-tabs button.active {
  background: #48508a;
}

.page {
  display: none;
}

.page.active {
  display: block;
}

#online-users-container {
  font-size: 0.85rem;
  margin-bottom: 10px;
}

/* ---------- CHAT ---------- */
#chat-container {
  display: flex;
  flex-direction: column;
  height: 70vh;
}

#chat-box {
  flex: 1;
  overflow-y: auto;
  border: 1px solid #48508a;
  padding: 6px;
  margin-bottom: 6px;
  font-size: 0.85rem;
}

#chat-input {
  width: calc(100% - 60px);
  padding: 6px;
  background: #3b4166;
  border: none;
  color: #c8d4e4;
}
</style>
</head>

<body>

<!-- ---------- LOCK SCREEN ---------- -->
<div class="screen" id="lock-screen">
  <h2>Enter Passcode</h2>
  <input class="input-field" id="passcode-input" type="password" />
  <button class="btn" id="unlock-btn" type="button">Unlock</button>
  <div id="error-msg"></div>
</div>

<!-- ---------- AUTH SCREEN ---------- -->
<div class="screen" id="auth-screen" style="display:none;">
  <h2>Log In / Sign Up</h2>
  <input class="input-field" id="auth-email" type="email" placeholder="Email" />
  <input class="input-field" id="auth-password" type="password" placeholder="Password" />
  <button class="btn" id="login-btn" type="button">Log In</button>
  <button class="btn" id="signup-btn" type="button">Sign Up</button>
  <div id="auth-error"></div>
</div>

<!-- ---------- MAIN ---------- -->
<div id="main-content">

  <div id="online-users-container">
    <strong>Online:</strong>
    <ul id="online-users-list"></ul>
  </div>

  <div id="nav-tabs">
    <button class="tab-btn active" data-page="quote-page">Main</button>
    <button class="tab-btn" data-page="chat-page">Chat</button>
  </div>

  <!-- QUOTE PAGE -->
  <div id="quote-page" class="page active">
    <div style="display: flex; justify-content: center; align-items: center; height: 60vh; flex-direction: column;">
      <div style="font-size: 2rem; text-align: center; line-height: 1.6;">
        "TRAVELLING IN A FRIED-OUT KOMBI, <br>
        ON A HIPPIE TRAIL HEAD FULL OF ZOMBIE"
      </div>
      <div style="margin-top: 20px; font-size: 1.2rem; opacity: 0.8;">
        <em> Down Under, Men At Work</em>
      </div>
    </div>
  </div>

  <!-- CHAT PAGE -->
  <div id="chat-page" class="page">
    <div id="chat-container">
      <div id="chat-box"></div>
      <input id="chat-input" placeholder="Type..." />
      <button id="send-btn" type="button">Send</button>
    </div>
  </div>

</div>

<!-- ---------- SCRIPT ---------- -->

<!-- Unlock runs independently, no Firebase needed -->
<script>
  let firebaseReady = false;
  let pendingUnlock = false;

  function tryUnlock() {
    const passcodeInput = document.getElementById("passcode-input");
    const lockScreen    = document.getElementById("lock-screen");
    const authScreen    = document.getElementById("auth-screen");
    const errorMsg      = document.getElementById("error-msg");

    if (passcodeInput.value === "092603") {
      lockScreen.style.display = "none";
      if (firebaseReady) {
        checkAuthAndStart();
      } else {
        pendingUnlock = true;
        authScreen.style.display = "flex";
      }
    } else {
      errorMsg.textContent = "Wrong passcode.";
    }
  }

  document.getElementById("unlock-btn").addEventListener("click", tryUnlock);
  document.getElementById("passcode-input").addEventListener("keypress", (e) => {
    if (e.key === "Enter") tryUnlock();
  });
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
import { getDatabase, ref, set, onValue, push, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

const lockScreen    = document.getElementById("lock-screen");
const authScreen    = document.getElementById("auth-screen");
const mainContent   = document.getElementById("main-content");
const authEmail     = document.getElementById("auth-email");
const authPassword  = document.getElementById("auth-password");
const loginBtn      = document.getElementById("login-btn");
const signupBtn     = document.getElementById("signup-btn");
const authError     = document.getElementById("auth-error");
const onlineUsersList = document.getElementById("online-users-list");
const chatBox       = document.getElementById("chat-box");
const chatInput     = document.getElementById("chat-input");
const sendBtn       = document.getElementById("send-btn");

const firebaseConfig = {
  apiKey: "AIzaSyBUmJ9k5pS62TzIkRHswO2lJLnaeRIfGmE",
  authDomain: "jess-chat-box.firebaseapp.com",
  projectId: "jess-chat-box",
  storageBucket: "jess-chat-box.appspot.com",
  messagingSenderId: "414967828897",
  appId: "1:414967828897:web:89045ed9bd4b3257c4bbe0"
};

const app  = initializeApp(firebaseConfig);
const db   = getDatabase(app);
const auth = getAuth(app);

firebaseReady = true;

window.checkAuthAndStart = function() {
  const currentUser = auth.currentUser;
  if (currentUser) {
    authScreen.style.display = "none";
    start(currentUser);
  } else {
    authScreen.style.display = "flex";
  }
};

onAuthStateChanged(auth, user => {
  if (user && lockScreen.style.display === "none" && authScreen.style.display !== "none") {
    authScreen.style.display = "none";
    start(user);
  }
});

loginBtn.onclick = () =>
  signInWithEmailAndPassword(auth, authEmail.value, authPassword.value)
    .catch(e => authError.textContent = e.message);

signupBtn.onclick = () =>
  createUserWithEmailAndPassword(auth, authEmail.value, authPassword.value)
    .catch(e => authError.textContent = e.message);

let chatCleared = false;

function start(user) {
  authScreen.style.display = "none";
  mainContent.style.display = "flex";

  const pRef = ref(db, "presence/" + user.uid);
  set(pRef, user.email);
  onDisconnect(pRef).remove();

  onValue(ref(db, "presence"), snap => {
    onlineUsersList.innerHTML = "";
    Object.values(snap.val() || {}).forEach(email => {
      const li = document.createElement("li");
      li.textContent = email;
      onlineUsersList.appendChild(li);
    });
  });

  if (!chatCleared) {
    chatCleared = true;
    remove(ref(db, "chat_river"));
  }

  setupChat(user.email);
  setupNavigation();
}

function setupNavigation() {
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
      document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById(btn.dataset.page).classList.add("active");
    };
  });
}

function setupChat(email) {
  const chatRef = ref(db, "chat_river");

  sendBtn.onclick = () => {
    if (!chatInput.value.trim()) return;
    push(chatRef, { name: email, text: chatInput.value, time: Date.now() });
    chatInput.value = "";
  };

  chatInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") sendBtn.click();
  });

  onValue(chatRef, snap => {
    chatBox.innerHTML = "";
    snap.forEach(m => {
      const d = document.createElement("div");
      d.textContent = `[${new Date(m.val().time).toLocaleTimeString()}] ${m.val().name}: ${m.val().text}`;
      chatBox.appendChild(d);
    });
    chatBox.scrollTop = chatBox.scrollHeight;
  });
}
</script>

</body>
</html>
